@echo off

REM Define the working directory
set WORK_DIR=%1
cd %WORK_DIR%

REM Check if 'topos' is in the path
where topos
echo %ERRORLEVEL%
if %ERRORLEVEL% EQU 0 (
    echo Topos is located at:
    where topos
) ELSE (
    echo Topos not found in the path.
)

REM Step 1: Download GitHub repo
echo Step 1: Downloading GitHub repository...
if exist "topos-cli" (
    echo Directory topos-cli already exists. Removing it...
    rmdir /s /q "topos-cli"
)

echo Cloning the repository...
git clone https://github.com/jonnyjohnson1/topos-cli

echo Finished downloading the latest GitHub repository!
cd topos-cli

REM Step 2: Check if poetry exists and build
where poetry >nul 2>nul
IF %ERRORLEVEL% EQU 0 (
    echo Poetry exists. Building with Poetry...
    poetry build
) ELSE (
    echo Poetry not found. Installing Poetry...
    powershell -Command "Invoke-WebRequest -Uri https://install.python-poetry.org -OutFile install-poetry.py"
    python install-poetry.py
    set PATH=%USERPROFILE%\.poetry\bin;%PATH%
    echo Building with Poetry...
    poetry build
)

REM Upgrade pip
echo Upgrading pip...
python -m pip install --upgrade pip

REM Step 3: Install the package
echo Step 3: Installing the package...
pip install .

echo Topos package installed!

REM Dynamically set the PATH for the user's local bin directory
for /f "delims=" %%a in ('python -m site --user-base') do set USER_BASE_PATH=%%a\Scripts
set PATH=%USER_BASE_PATH%;%PATH%

REM Step 4: Set the spacy model size
where topos
echo Step 4: Downloading spacy model...
topos set --spacy small

echo Installation complete!

REM Save path so we can use in dart
where topos > %USERPROFILE%\topos_path.txt

pause
